{% extends "layouts/base.html" %}

{% block title %}{{ _('Квартальный аналитический отчет') }} - {{ selected_complex }}{% endblock %}

{% block styles %}
<style>
    :root {
        --card-bg: #ffffff;
        --text-main: #212529;
        --chart-grid: #f0f0f0;
        --gold-primary: #B89B5E;
    }
    [data-bs-theme="dark"] {
        --card-bg: #2b3035;
        --text-main: #f8f9fa;
        --chart-grid: #444;
    }
    .kpi-card, .card {
        background-color: var(--card-bg) !important;
        color: var(--text-main);
        transition: transform 0.2s;
        border: none;
        border-radius: 12px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.05);
    }
    .kpi-card:hover { transform: translateY(-5px); }
    .trend-icon { font-size: 2.2rem; color: var(--gold-primary); width: 60px; text-align: center; }
    .chart-container { position: relative; height: 320px; width: 100%; }
    .table thead th { font-weight: 600; text-transform: uppercase; font-size: 0.8rem; letter-spacing: 0.5px; }
    .bg-gold-light { background-color: rgba(184, 155, 94, 0.1); }
    .text-gold { color: var(--gold-primary); }
    .usd-val { font-size: 0.85rem; opacity: 0.8; display: block; font-family: monospace; }
    .bg-light-themed { background-color: rgba(0,0,0,0.05); }
    [data-bs-theme="dark"] .bg-light-themed { background-color: rgba(255,255,255,0.05); }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2 class="h3 mb-0">{{ _('Квартальный аналитический отчет') }}</h2>
        <div class="text-muted small">1 USD = {{ "{:,.2f}".format(usd_to_uzs_rate) }} UZS</div>
    </div>

    <div class="card shadow-sm mb-4">
        <div class="card-body">
            <form method="GET" class="row g-3 align-items-end">
                <div class="col-md-4">
                    <label class="form-label fw-bold small text-uppercase opacity-75">{{ _('Проект') }}</label>
                    <select name="complex" class="form-select border-0 bg-light-themed">
                        {% for c in complexes %}
                            <option value="{{ c }}" {% if c == selected_complex %}selected{% endif %}>{{ c }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-uppercase opacity-75">{{ _('Год') }}</label>
                    <select name="year" class="form-select border-0 bg-light-themed">
                        {% for y in range(2022, 2027) %}
                            <option value="{{ y }}" {% if y == selected_year %}selected{% endif %}>{{ y }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label fw-bold small text-uppercase opacity-75">{{ _('Квартал') }}</label>
                    <select name="quarter" class="form-select border-0 bg-light-themed">
                        {% for q in range(1, 5) %}
                            <option value="{{ q }}" {% if q == selected_quarter %}selected{% endif %}>{{ q }} {{ _('квартал') }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2">
                    <button type="submit" class="btn btn-dark w-100 py-2">{{ _('Обновить') }}</button>
                </div>
            </form>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-md-4">
            <div class="card kpi-card border-start border-primary border-4">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs font-weight-bold text-primary text-uppercase mb-1">{{ _('Продано') }}</div>
                        <div class="h2 mb-0 font-weight-bold">{{ data.totals.sold }}</div>
                    </div>
                    <i class="bi bi-cart-check text-primary opacity-25 h1"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card border-start border-danger border-4">
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <div class="text-xs font-weight-bold text-danger text-uppercase mb-1">{{ _('Расторжения') }}</div>
                        <div class="h2 mb-0 font-weight-bold">{{ data.totals.cancellations }}</div>
                    </div>
                    <i class="bi bi-x-circle text-danger opacity-25 h1"></i>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="card kpi-card border-start border-warning border-4">
                <div class="card-body">
                    <div class="text-xs font-weight-bold text-warning text-uppercase mb-1">{{ _('Дебиторская задолженность') }}</div>
                    <div class="h2 mb-0 font-weight-bold">{{ "{:,.0f}".format(data.totals.debt).replace(',', ' ') }} <small class="h6">UZS</small></div>
                    <span class="usd-val text-warning">≈ {{ "{:,.2f}".format(data.totals.debt / usd_to_uzs_rate).replace(',', ' ') }} $</span>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-8">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent border-0"><h6 class="small text-uppercase fw-bold opacity-75">{{ _('Темпы реализации') }}</h6></div>
                <div class="card-body"><div class="chart-container"><canvas id="salesPaceChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-4">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent border-0"><h6 class="small text-uppercase fw-bold opacity-75">{{ _('Спец. сделки (Реестр)') }}</h6></div>
                <div class="card-body">
                    <div class="row g-2 text-center">
                        {% for code in ['vip', 'run', 'gift', 'k2'] %}
                        <div class="col-6"><div class="p-3 bg-light-themed rounded"><div class="small opacity-50 uppercase">{{ code }}</div>
                        <div class="h4 mb-0 fw-bold text-gold">{{ data.special_deals.get(code, 0) }}</div></div></div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4 mb-4">
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent border-0"><h6 class="small text-uppercase fw-bold opacity-75">{{ _('Виды оплаты') }}</h6></div>
                <div class="card-body"><div class="chart-container"><canvas id="paymentMethodsChart"></canvas></div></div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent border-0"><h6 class="small text-uppercase fw-bold opacity-75">{{ _('Тенденции объектов') }}</h6></div>
                <div class="card-body d-flex flex-column justify-content-center gap-4">
                    <div class="d-flex align-items-center"><div class="trend-icon"><i class="bi bi-rulers"></i></div>
                    <div class="ms-3"><div class="opacity-75 small">Средняя площадь</div><div class="h4 mb-0 fw-bold">{{ data.trends.avg_area }} м²</div></div></div>
                    <div class="d-flex align-items-center"><div class="trend-icon"><i class="bi bi-building"></i></div>
                    <div class="ms-3"><div class="opacity-75 small">Популярный этаж</div><div class="h4 mb-0 fw-bold">{{ data.trends.popular_floor }}</div></div></div>
                    <div class="d-flex align-items-center"><div class="trend-icon"><i class="bi bi-grid-3x3-gap"></i></div>
                    <div class="ms-3"><div class="opacity-75 small">Комнатность</div><div class="h4 mb-0 fw-bold">{{ data.trends.popular_rooms }}</div></div></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <div class="col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent border-0 d-flex justify-content-between"><h6>Лучшие менеджеры</h6><span class="badge bg-gold-light text-gold border border-gold">Топ-5</span></div>
                <div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light-themed"><tr><th class="ps-4">Менеджер</th><th class="text-center">Сделок</th><th class="text-end pe-4">Выручка</th></tr></thead>
                <tbody>{% for m in data.top_managers %}<tr><td class="ps-4">{{ m.manager_name }}</td><td class="text-center">{{ m.deals_count }}</td>
                <td class="text-end pe-4"><div class="fw-bold text-success">{{ "{:,.0f}".format(m.total_sum).replace(',', ' ') }}</div>
                <span class="usd-val text-muted">{{ "{:,.2f}".format(m.total_sum / usd_to_uzs_rate).replace(',', ' ') }} $</span></td></tr>{% endfor %}</tbody></table></div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card shadow-sm h-100">
                <div class="card-header bg-transparent border-0"><h6 class="text-danger">Главные неплательщики</h6></div>
                <div class="table-responsive"><table class="table table-hover align-middle mb-0"><thead class="bg-light-themed"><tr><th class="ps-4">ID Сделки</th><th class="text-end pe-4">Долг</th></tr></thead>
                <tbody>{% for d in data.top_debtors %}<tr><td class="ps-4">ID: {{ d.deal_id }}</td>
                <td class="text-end pe-4"><div class="text-danger fw-bold">{{ "{:,.0f}".format(d.debt).replace(',', ' ') }}</div>
                <span class="usd-val text-muted">{{ "{:,.2f}".format(d.debt / usd_to_uzs_rate).replace(',', ' ') }} $</span></td></tr>{% endfor %}</tbody></table></div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const isDark = document.documentElement.getAttribute('data-bs-theme') === 'dark';
        const textColor = isDark ? '#f8f9fa' : '#212529';
        const gridColor = isDark ? '#444' : '#f0f0f0';
        const palette = ['#B89B5E', '#3182ce', '#38a169', '#e53e3e', '#805ad5'];

        // Line Chart: Pace
        const qMonths = {1:['Январь','Февраль','Март'], 2:['Апрель','Май','Июнь'], 3:['Июль','Август','Сентябрь'], 4:['Октябрь','Ноябрь','Декабрь']};
        const salesData = {{ data.sales_pace | tojson }};
        new Chart(document.getElementById('salesPaceChart'), {
            type: 'line',
            data: { labels: qMonths[{{ selected_quarter }}], datasets: Object.keys(salesData).map((cat, i) => ({
                label: cat, data: salesData[cat], borderColor: palette[i%5], tension: 0.3, fill: false
            }))},
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: textColor }}},
                scales: { x: { ticks: { color: textColor }}, y: { grid: { color: gridColor }, ticks: { color: textColor, stepSize: 1 }}}
            }
        });

        // Doughnut: Payments
        const payData = {{ data.payment_methods | tojson }};
        new Chart(document.getElementById('paymentMethodsChart'), {
            type: 'doughnut',
            data: { labels: Object.keys(payData), datasets: [{ data: Object.values(payData), backgroundColor: palette, borderWidth: 0 }]},
            options: { responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: { legend: { position: 'right', labels: { color: textColor }}}}
        });
    });
</script>
{% endblock %}