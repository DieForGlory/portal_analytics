{% extends "layouts/base.html" %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h3 mb-0">{{ title }}</h1>

    <div class="d-flex align-items-center gap-3">
        <div class="input-group input-group-sm" style="width: 250px;">
            <span class="input-group-text bg-light"><i class="bi bi-layers"></i></span>
            <select class="form-select" id="groupBySelect">
                <option value="complex" {% if group_by == 'complex' %}selected{% endif %}>Группировать по проектам</option>
                <option value="house" {% if group_by == 'house' %}selected{% endif %}>Группировать по домам</option>
            </select>
        </div>

        <div class="form-check form-switch ms-2">
            <input class="form-check-input" type="checkbox" role="switch" id="currencyToggle">
            <label class="form-check-label fw-bold" for="currencyToggle" id="currencyLabel">UZS</label>
        </div>

        <div class="btn-group">
            <a id="export-link"
               data-base-url="{{ url_for('report.export_inventory_summary') }}"
               href="#"
               class="btn btn-outline-success">
                <i class="bi bi-file-earmark-excel me-1"></i>Общий экспорт
            </a>
            <a id="export-comm-link"
               data-base-url="{{ url_for('report.export_commercial_inventory') }}"
               href="#"
               class="btn btn-outline-info">
                <i class="bi bi-shop me-1"></i>Коммерция (этажи)
            </a>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-primary text-white">
            <div class="card-body">
                <h6 class="card-title opacity-75">Общий остаток (шт)</h6>
                <h2 class="mb-0">{{ totals.total_count }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-success text-white">
            <div class="card-body">
                <h6 class="card-title opacity-75">Общая площадь (м²)</h6>
                <h2 class="mb-0">{{ "{:,.2f}".format(totals.total_area)|replace(',', ' ') }}</h2>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card border-0 shadow-sm bg-dark text-white">
            <div class="card-body">
                <h6 class="card-title opacity-75">Общая стоимость</h6>
                <h2 class="mb-0 currency-value" data-uzs-value="{{ totals.total_value }}">
                    {{ "{:,.0f}".format(totals.total_value)|replace(',', ' ') }}
                </h2>
            </div>
        </div>
    </div>
</div>

<div class="mb-3">
    <input type="text" id="projectSearchInput" class="form-control" placeholder="Поиск по названию...">
</div>

<div class="card shadow-sm border-0">
    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0" id="inventoryTable">
            <thead class="table-light">
                <tr>
                    <th class="ps-3">Наименование</th>
                    <th class="text-center">Кол-во (шт)</th>
                    <th class="text-end">Площадь (м²)</th>
                    <th class="text-end">Средняя цена за м²</th>
                    <th class="text-end pe-3">Общая стоимость</th>
                </tr>
            </thead>
            <tbody>
                {% for row in data %}
                <tr>
                    <td class="ps-3 fw-bold">{{ row.name }}</td>
                    <td class="text-center">{{ row.count }}</td>
                    <td class="text-end">{{ "{:,.2f}".format(row.area)|replace(',', ' ') }}</td>
                    <td class="text-end currency-value" data-uzs-value="{{ row.avg_price_m2 }}">
                        {{ "{:,.0f}".format(row.avg_price_m2)|replace(',', ' ') }}
                    </td>
                    <td class="text-end fw-bold pe-3 currency-value" data-uzs-value="{{ row.total_value }}">
                        {{ "{:,.0f}".format(row.total_value)|replace(',', ' ') }}
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block scripts %}
{{ super() }}
<script>
    // Передача курса из бэкенда
    document.body.dataset.usdRate = "{{ usd_to_uzs_rate or 12650 }}";

    const exportLink = document.getElementById('export-link');
    const exportCommLink = document.getElementById('export-comm-link');
    const groupBySelect = document.getElementById('groupBySelect');
    const currencyToggle = document.getElementById('currencyToggle');

    /**
     * Синхронизация URL кнопок экспорта с текущими фильтрами страницы
     */
    function updateExportUrls() {
        const currency = currencyToggle.checked ? 'USD' : 'UZS';
        const groupBy = groupBySelect.value;

        // Обновление основной ссылки
        if (exportLink) {
            const base = exportLink.dataset.baseUrl;
            const url = new URL(base, window.location.origin);
            url.searchParams.set('currency', currency);
            url.searchParams.set('group_by', groupBy);
            exportLink.href = url.toString();
        }

        // Обновление ссылки для коммерции
        if (exportCommLink) {
            const baseComm = exportCommLink.dataset.baseUrl;
            const urlComm = new URL(baseComm, window.location.origin);
            urlComm.searchParams.set('currency', currency);
            exportCommLink.href = urlComm.toString();
        }
    }

    // Слушатели изменений
    groupBySelect.addEventListener('change', () => {
        // Перезагрузка страницы для смены группировки в БД
        const url = new URL(window.location.href);
        url.searchParams.set('group_by', groupBySelect.value);
        window.location.href = url.toString();
    });

    currencyToggle.addEventListener('change', updateExportUrls);

    // Первичная настройка ссылок при загрузке
    updateExportUrls();
</script>
<script src="{{ url_for('static', filename='js/report_script.js') }}"></script>
{% endblock %}