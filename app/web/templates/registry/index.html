{% extends "layouts/base.html" %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">Реестр спец. сделок</h1>
</div>

<div class="card">
    <div class="card-header">
        <ul class="nav nav-tabs card-header-tabs" id="registryTabs" role="tablist">
            <li class="nav-item">
                <a class="nav-link active" id="vip-tab" data-bs-toggle="tab" href="#vip" role="tab" aria-controls="vip" aria-selected="true">VIP сделки</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="run-tab" data-bs-toggle="tab" href="#run" role="tab" aria-controls="run" aria-selected="false">Прогоны</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="gift-tab" data-bs-toggle="tab" href="#gift" role="tab" aria-controls="gift" aria-selected="false">Подарки</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" id="k2-tab" data-bs-toggle="tab" href="#k2" role="tab" aria-controls="k2" aria-selected="false">К2 сделки</a>
            </li>
        </ul>
    </div>
    <div class="card-body">
        <div class="tab-content" id="registryTabsContent">
            {% for type_key, items in data.items() %}
            <div class="tab-pane fade {% if type_key == 'vip' %}show active{% endif %}" id="{{ type_key }}" role="tabpanel" aria-labelledby="{{ type_key }}-tab">

                <form action="{{ url_for('registry.add_deal') }}" method="POST" class="row g-3 align-items-end mb-4 border-bottom pb-4">
                    <input type="hidden" name="registry_type" value="{{ type_key }}">

                    <div class="col-auto">
                        <label class="form-label mb-0 fw-bold">ID Объекта</label>
                        <input type="number" name="sell_id" class="form-control" placeholder="Например: 12345" required>
                    </div>

                    {# Показываем поля сумм ТОЛЬКО для вкладки К2 #}
                    {% if type_key == 'k2' %}
                    <div class="col-auto">
                        <label class="form-label mb-0 fw-bold text-primary">Сумма К2</label>
                        <input type="number" step="0.01" name="k2_sum" class="form-control" placeholder="0.00">
                    </div>
                    <div class="col-auto">
                        <label class="form-label mb-0 fw-bold text-success">Сумма в CRM</label>
                        <input type="number" step="0.01" name="crm_sum" class="form-control" placeholder="0.00">
                    </div>
                    {% endif %}

                    <div class="col-auto">
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-plus"></i> Добавить
                        </button>
                    </div>
                </form>

                <div class="table-responsive">
                    <table class="table table-striped table-hover table-sm align-middle">
                        <thead class="table-light">
                            <tr>
                                <th>ID Объекта</th>
                                <th>ЖК / Дом</th>
                                <th>Описание</th>

                                {% if type_key == 'k2' %}
                                    <th>Сумма К2</th>
                                    <th>Сумма CRM</th>
                                {% endif %}

                                <th>Площадь</th>
                                <th>Стоимость (База)</th>
                                <th>Статус</th>
                                <th>Дата добавления</th>
                                <th>Действия</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% if items %}
                                {% for item in items %}
                                <tr>
                                    <td>
                                        <a href="{{ url_for('main.apartment_details', sell_id=item.sell_id) }}" target="_blank" class="fw-bold text-decoration-none">
                                            {{ item.sell_id }} <i class="fas fa-external-link-alt small"></i>
                                        </a>
                                    </td>
                                    <td>
                                        <div>{{ item.complex }}</div>
                                        <small class="text-muted">{{ item.house }}</small>
                                    </td>
                                    <td>{{ item.number }}</td>

                                    {# Значения ячеек для К2 #}
                                    {% if type_key == 'k2' %}
                                        <td class="text-primary fw-bold">
                                            {% if item.k2_sum %}
                                                {{ "{:,.0f}".format(item.k2_sum).replace(',', ' ') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                        <td class="text-success">
                                            {% if item.crm_sum %}
                                                {{ "{:,.0f}".format(item.crm_sum).replace(',', ' ') }}
                                            {% else %}
                                                -
                                            {% endif %}
                                        </td>
                                    {% endif %}

                                    <td>{{ item.area }} м²</td>
                                    <td>
                                        {% if item.price %}
                                            {{ "{:,.0f}".format(item.price).replace(',', ' ') }}
                                        {% else %}
                                            0
                                        {% endif %}
                                    </td>
                                    <td>
                                        <span class="badge bg-secondary">{{ item.status }}</span>
                                    </td>
                                    <td class="text-muted small">{{ item.added_at }}</td>
                                    <td>
                                        <form action="{{ url_for('registry.delete_deal', id=item.registry_id) }}" method="POST" onsubmit="return confirm('Вы уверены, что хотите удалить эту запись из реестра?');">
                                            <button type="submit" class="btn btn-sm btn-outline-danger" title="Удалить">
                                                <span data-feather="trash-2"></span> Удалить
                                            </button>
                                        </form>
                                    </td>
                                </tr>
                                {% endfor %}
                            {% else %}
                                <tr>
                                    <td colspan="{% if type_key == 'k2' %}10{% else %}8{% endif %}" class="text-center text-muted py-4">
                                        В этом реестре пока нет записей. Добавьте первую сделку через форму выше.
                                    </td>
                                </tr>
                            {% endif %}
                        </tbody>
                    </table>
                </div>

            </div>
            {% endfor %}
        </div>
    </div>
</div>
{% endblock %}